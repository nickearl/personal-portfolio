# BaseIQ Insights Dashboard

BaseIQ is an executive dashboard and analytics platform built for Basemakers. It hosts various tools and scorecards to provide insights into territory performance, representative metrics, pricing, and prioritization.

The application is built using **Flask** as the web framework and **Plotly Dash** for interactive analytics, with **Redis** and **Celery** managing background tasks and caching.

## ğŸš€ Features

*   **Interactive Dashboards:**
    *   **Territory Scorecard:** KPI overview by territory.
    *   **Rep Scorecard:** Field representative performance metrics.
    *   **Prioritization Tool:** Rank and visualize performance combinations.
    *   **Pricing Tool:** Quantify expansion opportunities.
*   **Authentication:** Google OAuth 2.0 integration via `flask-dance`.
*   **Access Control:** Page-level user authorization.
*   **Background Processing:** Asynchronous task execution using Celery and Redis.
*   **Infrastructure:** Dockerized deployment managed by Terraform on GCP.
*   **DNS Management:** Automated DNS records via Cloudflare.

## ğŸ› ï¸ Tech Stack

*   **Backend:** Python 3.13, Flask
*   **Frontend:** Plotly Dash, Dash Bootstrap Components
*   **Data Processing:** Pandas, NumPy, DuckDB
*   **Task Queue & Caching:** Celery, Redis
*   **Infrastructure:** Docker, Terraform, Google Cloud Platform (GCP)
*   **Package Manager:** `uv` (recommended) or `pip`

## ğŸ“‚ Project Structure

```text
base-insights-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ app.py                  # Main Flask entry point
â”‚   â”œâ”€â”€ auth.py                 # Google OAuth & session logic
â”‚   â”œâ”€â”€ conf.py                 # Global UI configuration & page definitions
â”‚   â”œâ”€â”€ dash_app/
â”‚   â”‚   â”œâ”€â”€ callbacks.py        # Centralized Dash callbacks
â”‚   â”‚   â”œâ”€â”€ components.py       # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ pages/              # Individual dashboard pages (Rep, Territory, etc.)
â”‚   â”‚   â””â”€â”€ assets/             # Static assets (CSS, Images)
â”‚   â”œâ”€â”€ pyproject.toml          # Dependencies
â”‚   â””â”€â”€ Dockerfile              # App container definition
â”œâ”€â”€ modules/                    # Terraform modules
â”œâ”€â”€ scripts/                    # Helper scripts & templates
â”œâ”€â”€ bootstrap.sh                # Deployment script
â”œâ”€â”€ main.tf                     # Main Terraform configuration
â””â”€â”€ variables.tf                # Terraform variables
```

## âš¡ Local Development

### Prerequisites

*   Python 3.13+
*   [uv](https://github.com/astral-sh/uv) (for dependency management)
*   Redis (running locally or accessible via URL)

### 1. Clone & Setup

```bash
git clone <repository-url>
cd base-insights-app
uv sync  # Installs dependencies from uv.lock
```

### 2. Environment Variables

Create a `.env` file in the repository root directory with the following keys:

```ini
DEPLOY_ENV=dev
FLASK_SECRET_KEY=<your-secret-key>
FLASK_ENCRYPTION_KEY=<fernet-key>
REDIS_URL=redis://localhost:6379/0
SERVER_NAME=Base-Insights
DISPLAY_NAME=BaseIQ
ENABLE_GOOGLE_AUTH=true # or false for local dev without auth
GOOGLE_OAUTH_CLIENT_ID=<client-id>
GOOGLE_OAUTH_CLIENT_SECRET=<client-secret>
```

### 3. Running the App

You need two terminal sessions:

**Terminal 1: Flask/Dash Server**
```bash
flask --app ./app/app run -p 1701
```

**Terminal 2: Celery Worker**
```bash
celery --workdir app -A app:celery_app worker --loglevel=INFO --concurrency=2 -Q Base-Insights
```

The app will be available at `http://localhost:1701/`.

## ğŸš¢ Deployment

Deployment is managed via **Terraform** and **Docker**.

### Build & Deploy
The `bootstrap.sh` script handles Terraform initialization and application.

```bash
./bootstrap.sh
```

Infrastructure configuration is located in `main.tf`, `variables.tf`, and the `modules/` directory.

### CI/CD Pipeline
Updates are automated via GitHub Actions (`.github/workflows/deploy.yml`).

**Requirements:**
1.  **Terraform:** Terraform will automatically create the required Google Artifact Registry repository.
2.  **GitHub Secrets:** You must add the secrets generated by Terraform to your GitHub repository.

**How to configure secrets:**

1.  Run the following command to view the secret values:
    ```bash
    terraform output -raw github_secrets
    ```
2.  Go to your GitHub Repository.
3.  Navigate to **Settings** > **Secrets and variables** > **Actions**.
4.  Click **New repository secret** and add the following three secrets using the values from the terminal output:
    *   `GCP_WORKLOAD_IDENTITY_PROVIDER`
    *   `GCP_SERVICE_ACCOUNT`
    *   `GCP_SSH_PRIVATE_KEY` (Copy the entire multi-line key including `-----BEGIN...` and `-----END...`)

### DNS & SSL
DNS is managed by Cloudflare. Ensure you have the following variables in your `terraform.tfvars`:
*   `cloudflare_api_token`: API Token with `Zone.DNS` permissions.
*   `cloudflare_zone_id`: The Zone ID for your domain found in the Cloudflare dashboard.

## ğŸ” Authentication & Access

*   **Google Auth:** Managed in `app/auth.py`.
*   **Access Control:**
    *   **Groups:** Permissions are defined in `app/conf.py` using `permission_groups` which map internal departments (from `internal_employees`) to roles (e.g., `EXECUTIVE`, `FIELD_LEADERSHIP`).
    *   **Page Access:** Each page in `conf.py` defines which `access_groups` are allowed to view it.
    *   **Rep Scorecard:** Implements row-level security. Users see themselves and their direct reports. Users in specific high-level groups (e.g., `TECHNOLOGY`) can view all Field Sales reps.

## ğŸ§ª Testing

*   **Linting:** `ruff check .` (if installed)
*   **Type Checking:** `mypy .` (if configured)
